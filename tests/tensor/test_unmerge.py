# Copyright 2024 The YASTN Authors. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ==============================================================================
""" Test elements of yastn.fuse_legs(... mode='hard') """
from itertools import groupby
import numpy as np
import pytest
import yastn

tol = 1e-10  #pylint: disable=invalid-name


def unmerge(data, meta):
    newdata = np.empty_like(data)  # this does not introduce zero blocks
    for sln, Dn, slo, Do, sub_slc in meta:
        slcs = tuple(slice(*x) for x in sub_slc)
        newdata[slice(*sln)].reshape(Dn)[:] = data[slice(*slo)].reshape(Do)[slcs]
    return newdata


def unmerge2(data, meta2):
    newdata = np.empty_like(data)  # this does not introduce zero blocks
    for (slo, Do), gr in groupby(meta2, key = lambda x: x[2]):
        dd = data[slice(*slo)].reshape(Do)
        for sln, Dn, _, sub_slc in gr:
            slcs = tuple(slice(*x) for x in sub_slc)
            newdata[slice(*sln)].reshape(Dn)[:] = dd[slcs]
    return newdata


@pytest.mark.skipif("'np' not in config.getoption('--backend')",
                    reason="this test explicitly uses numpy array; will become obsolate after introducing views")
def test_hard_unmerge(config_kwargs):
    config_U1 = yastn.make_config(sym='U1', **config_kwargs)
    a = yastn.ones(config=config_U1, s=(-1, -1, -1, 1, 1, 1),
                  t=[(0, 1, 2), (0, 1, 2), (0, 1, 2), (0, 1, 2), (0, 1, 2), (0, 1, 2)],
                  D=[(1, 2, 3), (2, 3, 4), (3, 4, 5), (4, 5, 6), (5, 6, 7), (6, 7, 8)])

    meta = (((0, 720), (6, 120), (0, 720), (6, 120), ((0, 6), (0, 120))), ((720, 1840), (8, 140), (720, 13306), (29, 434), ((0, 8), (0, 140))), ((1840, 2992), (8, 144), (720, 13306), (29, 434), ((0, 8), (140, 284))), ((2992, 4192), (8, 150), (720, 13306), (29, 434), ((0, 8), (284, 434))), ((4192, 5792), (10, 160), (13306, 101972), (86, 1031), ((0, 10), (0, 160))), ((5792, 7472), (10, 168), (13306, 101972), (86, 1031), ((0, 10), (160, 328))), ((7472, 9152), (10, 168), (13306, 101972), (86, 1031), ((0, 10), (328, 496))), ((9152, 10902), (10, 175), (13306, 101972), (86, 1031), ((0, 10), (496, 671))), ((10902, 12702), (10, 180), (13306, 101972), (86, 1031), ((0, 10), (671, 851))), ((12702, 14502), (10, 180), (13306, 101972), (86, 1031), ((0, 10), (851, 1031))), ((14502, 15762), (9, 140), (720, 13306), (29, 434), ((8, 17), (0, 140))), ((15762, 17058), (9, 144), (720, 13306), (29, 434), ((8, 17), (140, 284))), ((17058, 18408), (9, 150), (720, 13306), (29, 434), ((8, 17), (284, 434))), ((18408, 20328), (12, 160), (13306, 101972), (86, 1031), ((10, 22), (0, 160))), ((20328, 22344), (12, 168), (13306, 101972), (86, 1031), ((10, 22), (160, 328))), ((22344, 24360), (12, 168), (13306, 101972), (86, 1031), ((10, 22), (328, 496))), ((24360, 26460), (12, 175), (13306, 101972), (86, 1031), ((10, 22), (496, 671))), ((26460, 28620), (12, 180), (13306, 101972), (86, 1031), ((10, 22), (671, 851))), ((28620, 30780), (12, 180), (13306, 101972), (86, 1031), ((10, 22), (851, 1031))), ((30780, 33660), (15, 192), (101972, 317072), (150, 1434), ((0, 15), (0, 192))), ((33660, 36600), (15, 196), (101972, 317072), (150, 1434), ((0, 15), (192, 388))), ((36600, 39600), (15, 200), (101972, 317072), (150, 1434), ((0, 15), (388, 588))), ((39600, 42750), (15, 210), (101972, 317072), (150, 1434), ((0, 15), (588, 798))), ((42750, 45900), (15, 210), (101972, 317072), (150, 1434), ((0, 15), (798, 1008))), ((45900, 49050), (15, 210), (101972, 317072), (150, 1434), ((0, 15), (1008, 1218))), ((49050, 52290), (15, 216), (101972, 317072), (150, 1434), ((0, 15), (1218, 1434))), ((52290, 54210), (12, 160), (13306, 101972), (86, 1031), ((22, 34), (0, 160))), ((54210, 56226), (12, 168), (13306, 101972), (86, 1031), ((22, 34), (160, 328))), ((56226, 58242), (12, 168), (13306, 101972), (86, 1031), ((22, 34), (328, 496))), ((58242, 60342), (12, 175), (13306, 101972), (86, 1031), ((22, 34), (496, 671))), ((60342, 62502), (12, 180), (13306, 101972), (86, 1031), ((22, 34), (671, 851))), ((62502, 64662), (12, 180), (13306, 101972), (86, 1031), ((22, 34), (851, 1031))), ((64662, 67734), (16, 192), (101972, 317072), (150, 1434), ((15, 31), (0, 192))), ((67734, 70870), (16, 196), (101972, 317072), (150, 1434), ((15, 31), (192, 388))), ((70870, 74070), (16, 200), (101972, 317072), (150, 1434), ((15, 31), (388, 588))), ((74070, 77430), (16, 210), (101972, 317072), (150, 1434), ((15, 31), (588, 798))), ((77430, 80790), (16, 210), (101972, 317072), (150, 1434), ((15, 31), (798, 1008))), ((80790, 84150), (16, 210), (101972, 317072), (150, 1434), ((15, 31), (1008, 1218))), ((84150, 87606), (16, 216), (101972, 317072), (150, 1434), ((15, 31), (1218, 1434))), ((87606, 92086), (20, 224), (317072, 584424), (184, 1453), ((0, 20), (0, 224))), ((92086, 96886), (20, 240), (317072, 584424), (184, 1453), ((0, 20), (224, 464))), ((96886, 101786), (20, 245), (317072, 584424), (184, 1453), ((0, 20), (464, 709))), ((101786, 106586), (20, 240), (317072, 584424), (184, 1453), ((0, 20), (709, 949))), ((106586, 111626), (20, 252), (317072, 584424), (184, 1453), ((0, 20), (949, 1201))), ((111626, 116666), (20, 252), (317072, 584424), (184, 1453), ((0, 20), (1201, 1453))), ((116666, 118346), (12, 140), (720, 13306), (29, 434), ((17, 29), (0, 140))), ((118346, 120074), (12, 144), (720, 13306), (29, 434), ((17, 29), (140, 284))), ((120074, 121874), (12, 150), (720, 13306), (29, 434), ((17, 29), (284, 434))), ((121874, 124434), (16, 160), (13306, 101972), (86, 1031), ((34, 50), (0, 160))), ((124434, 127122), (16, 168), (13306, 101972), (86, 1031), ((34, 50), (160, 328))), ((127122, 129810), (16, 168), (13306, 101972), (86, 1031), ((34, 50), (328, 496))), ((129810, 132610), (16, 175), (13306, 101972), (86, 1031), ((34, 50), (496, 671))), ((132610, 135490), (16, 180), (13306, 101972), (86, 1031), ((34, 50), (671, 851))), ((135490, 138370), (16, 180), (13306, 101972), (86, 1031), ((34, 50), (851, 1031))), ((138370, 142210), (20, 192), (101972, 317072), (150, 1434), ((31, 51), (0, 192))), ((142210, 146130), (20, 196), (101972, 317072), (150, 1434), ((31, 51), (192, 388))), ((146130, 150130), (20, 200), (101972, 317072), (150, 1434), ((31, 51), (388, 588))), ((150130, 154330), (20, 210), (101972, 317072), (150, 1434), ((31, 51), (588, 798))), ((154330, 158530), (20, 210), (101972, 317072), (150, 1434), ((31, 51), (798, 1008))), ((158530, 162730), (20, 210), (101972, 317072), (150, 1434), ((31, 51), (1008, 1218))), ((162730, 167050), (20, 216), (101972, 317072), (150, 1434), ((31, 51), (1218, 1434))), ((167050, 169930), (18, 160), (13306, 101972), (86, 1031), ((50, 68), (0, 160))), ((169930, 172954), (18, 168), (13306, 101972), (86, 1031), ((50, 68), (160, 328))), ((172954, 175978), (18, 168), (13306, 101972), (86, 1031), ((50, 68), (328, 496))), ((175978, 179128), (18, 175), (13306, 101972), (86, 1031), ((50, 68), (496, 671))), ((179128, 182368), (18, 180), (13306, 101972), (86, 1031), ((50, 68), (671, 851))), ((182368, 185608), (18, 180), (13306, 101972), (86, 1031), ((50, 68), (851, 1031))), ((185608, 190216), (24, 192), (101972, 317072), (150, 1434), ((51, 75), (0, 192))), ((190216, 194920), (24, 196), (101972, 317072), (150, 1434), ((51, 75), (192, 388))), ((194920, 199720), (24, 200), (101972, 317072), (150, 1434), ((51, 75), (388, 588))), ((199720, 204760), (24, 210), (101972, 317072), (150, 1434), ((51, 75), (588, 798))), ((204760, 209800), (24, 210), (101972, 317072), (150, 1434), ((51, 75), (798, 1008))), ((209800, 214840), (24, 210), (101972, 317072), (150, 1434), ((51, 75), (1008, 1218))), ((214840, 220024), (24, 216), (101972, 317072), (150, 1434), ((51, 75), (1218, 1434))), ((220024, 226744), (30, 224), (317072, 584424), (184, 1453), ((20, 50), (0, 224))), ((226744, 233944), (30, 240), (317072, 584424), (184, 1453), ((20, 50), (224, 464))), ((233944, 241294), (30, 245), (317072, 584424), (184, 1453), ((20, 50), (464, 709))), ((241294, 248494), (30, 240), (317072, 584424), (184, 1453), ((20, 50), (709, 949))), ((248494, 256054), (30, 252), (317072, 584424), (184, 1453), ((20, 50), (949, 1201))), ((256054, 263614), (30, 252), (317072, 584424), (184, 1453), ((20, 50), (1201, 1453))), ((263614, 268222), (24, 192), (101972, 317072), (150, 1434), ((75, 99), (0, 192))), ((268222, 272926), (24, 196), (101972, 317072), (150, 1434), ((75, 99), (192, 388))), ((272926, 277726), (24, 200), (101972, 317072), (150, 1434), ((75, 99), (388, 588))), ((277726, 282766), (24, 210), (101972, 317072), (150, 1434), ((75, 99), (588, 798))), ((282766, 287806), (24, 210), (101972, 317072), (150, 1434), ((75, 99), (798, 1008))), ((287806, 292846), (24, 210), (101972, 317072), (150, 1434), ((75, 99), (1008, 1218))), ((292846, 298030), (24, 216), (101972, 317072), (150, 1434), ((75, 99), (1218, 1434))), ((298030, 305198), (32, 224), (317072, 584424), (184, 1453), ((50, 82), (0, 224))), ((305198, 312878), (32, 240), (317072, 584424), (184, 1453), ((50, 82), (224, 464))), ((312878, 320718), (32, 245), (317072, 584424), (184, 1453), ((50, 82), (464, 709))), ((320718, 328398), (32, 240), (317072, 584424), (184, 1453), ((50, 82), (709, 949))), ((328398, 336462), (32, 252), (317072, 584424), (184, 1453), ((50, 82), (949, 1201))), ((336462, 344526), (32, 252), (317072, 584424), (184, 1453), ((50, 82), (1201, 1453))), ((344526, 355726), (40, 280), (584424, 699070), (133, 862), ((0, 40), (0, 280))), ((355726, 367246), (40, 288), (584424, 699070), (133, 862), ((0, 40), (280, 568))), ((367246, 379006), (40, 294), (584424, 699070), (133, 862), ((0, 40), (568, 862))), ((379006, 381886), (18, 160), (13306, 101972), (86, 1031), ((68, 86), (0, 160))), ((381886, 384910), (18, 168), (13306, 101972), (86, 1031), ((68, 86), (160, 328))), ((384910, 387934), (18, 168), (13306, 101972), (86, 1031), ((68, 86), (328, 496))), ((387934, 391084), (18, 175), (13306, 101972), (86, 1031), ((68, 86), (496, 671))), ((391084, 394324), (18, 180), (13306, 101972), (86, 1031), ((68, 86), (671, 851))), ((394324, 397564), (18, 180), (13306, 101972), (86, 1031), ((68, 86), (851, 1031))), ((397564, 402172), (24, 192), (101972, 317072), (150, 1434), ((99, 123), (0, 192))), ((402172, 406876), (24, 196), (101972, 317072), (150, 1434), ((99, 123), (192, 388))), ((406876, 411676), (24, 200), (101972, 317072), (150, 1434), ((99, 123), (388, 588))), ((411676, 416716), (24, 210), (101972, 317072), (150, 1434), ((99, 123), (588, 798))), ((416716, 421756), (24, 210), (101972, 317072), (150, 1434), ((99, 123), (798, 1008))), ((421756, 426796), (24, 210), (101972, 317072), (150, 1434), ((99, 123), (1008, 1218))), ((426796, 431980), (24, 216), (101972, 317072), (150, 1434), ((99, 123), (1218, 1434))), ((431980, 438700), (30, 224), (317072, 584424), (184, 1453), ((82, 112), (0, 224))), ((438700, 445900), (30, 240), (317072, 584424), (184, 1453), ((82, 112), (224, 464))), ((445900, 453250), (30, 245), (317072, 584424), (184, 1453), ((82, 112), (464, 709))), ((453250, 460450), (30, 240), (317072, 584424), (184, 1453), ((82, 112), (709, 949))), ((460450, 468010), (30, 252), (317072, 584424), (184, 1453), ((82, 112), (949, 1201))), ((468010, 475570), (30, 252), (317072, 584424), (184, 1453), ((82, 112), (1201, 1453))), ((475570, 480754), (27, 192), (101972, 317072), (150, 1434), ((123, 150), (0, 192))), ((480754, 486046), (27, 196), (101972, 317072), (150, 1434), ((123, 150), (192, 388))), ((486046, 491446), (27, 200), (101972, 317072), (150, 1434), ((123, 150), (388, 588))), ((491446, 497116), (27, 210), (101972, 317072), (150, 1434), ((123, 150), (588, 798))), ((497116, 502786), (27, 210), (101972, 317072), (150, 1434), ((123, 150), (798, 1008))), ((502786, 508456), (27, 210), (101972, 317072), (150, 1434), ((123, 150), (1008, 1218))), ((508456, 514288), (27, 216), (101972, 317072), (150, 1434), ((123, 150), (1218, 1434))), ((514288, 522352), (36, 224), (317072, 584424), (184, 1453), ((112, 148), (0, 224))), ((522352, 530992), (36, 240), (317072, 584424), (184, 1453), ((112, 148), (224, 464))), ((530992, 539812), (36, 245), (317072, 584424), (184, 1453), ((112, 148), (464, 709))), ((539812, 548452), (36, 240), (317072, 584424), (184, 1453), ((112, 148), (709, 949))), ((548452, 557524), (36, 252), (317072, 584424), (184, 1453), ((112, 148), (949, 1201))), ((557524, 566596), (36, 252), (317072, 584424), (184, 1453), ((112, 148), (1201, 1453))), ((566596, 579196), (45, 280), (584424, 699070), (133, 862), ((40, 85), (0, 280))), ((579196, 592156), (45, 288), (584424, 699070), (133, 862), ((40, 85), (280, 568))), ((592156, 605386), (45, 294), (584424, 699070), (133, 862), ((40, 85), (568, 862))), ((605386, 613450), (36, 224), (317072, 584424), (184, 1453), ((148, 184), (0, 224))), ((613450, 622090), (36, 240), (317072, 584424), (184, 1453), ((148, 184), (224, 464))), ((622090, 630910), (36, 245), (317072, 584424), (184, 1453), ((148, 184), (464, 709))), ((630910, 639550), (36, 240), (317072, 584424), (184, 1453), ((148, 184), (709, 949))), ((639550, 648622), (36, 252), (317072, 584424), (184, 1453), ((148, 184), (949, 1201))), ((648622, 657694), (36, 252), (317072, 584424), (184, 1453), ((148, 184), (1201, 1453))), ((657694, 671134), (48, 280), (584424, 699070), (133, 862), ((85, 133), (0, 280))), ((671134, 684958), (48, 288), (584424, 699070), (133, 862), ((85, 133), (280, 568))), ((684958, 699070), (48, 294), (584424, 699070), (133, 862), ((85, 133), (568, 862))), ((699070, 719230), (60, 336), (699070, 719230), (60, 336), ((0, 60), (0, 336))))

    meta2 = [(x[0], x[1], (x[2], x[3]), x[4]) for x in meta]
    meta2 = sorted(meta2, key = lambda x: x[2])

    b = a.fuse_legs(axes=((0, 1, 2), (3, 4, 5)), mode='hard')

    for _ in range(1000):
        cc = unmerge(b.data, meta)

    for _ in range(1000):
        dd = unmerge2(b.data, meta2)

        # c = b.unfuse_legs(axes=(0, 1))

    assert max(abs(cc - dd)) < 1e-12


if __name__ == '__main__':
    pytest.main([__file__, "-vs", "--durations=0"])
